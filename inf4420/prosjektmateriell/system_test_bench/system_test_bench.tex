\documentclass[english, a4paper,11pt]{article}
\usepackage[utf8]{inputenc}
\usepackage[T1]{fontenc,url} %url
\urlstyle{sf} %sf
\usepackage{babel,textcomp,csquotes, varioref,graphicx, gensymb}
% \usepackage[]{circuitikz}
\usepackage{tikz}
\usetikzlibrary{shapes,arrows}
\usepackage[backend=biber,style=numeric-comp, sortcites]{biblatex}

\bibliography{ref.bib} 

%opening
\title{Complete system testbech}
\author{Espen Klein Nilsen and \\Vegard MidtbÃ¸en}

\begin{document}

\maketitle

\section{Report contents}
This report contains a brief explanation of the different part in our project.   

\section{Structure}
The overall structure of the system is seen in Figure \ref{block_diagram}.

\tikzstyle{block} = [draw, fill=blue!20, rectangle, 
    minimum height=4em, minimum width=3em]
\tikzstyle{input} = [coordinate]
\tikzstyle{output} = [coordinate]
\tikzstyle{pinstyle} = [pin edge={to-,thin,black}]
\begin{figure}[!ht]
  \begin{tikzpicture}[auto, node distance=2cm,>=latex']
      % We start by placing the blocks
      \node [input, name=input] {};
      \node [block, right of=input, node distance=2cm] (sample_and_hold) {S\&H};
      \node [block, right of=sample_and_hold, node distance=4cm] (comparator) {Comparator};
      \node [block, right of=comparator, node distance=4cm] (sar_logic) {SAR Logic};
      
      % We draw an edge between the controller and system block to 
      % calculate the coordinate xsh(t). We need it to place the measurement block. 
      \draw [->] (sample_and_hold) -- node[name=xsh(t)] {$x_{sh}(t)$} (comparator);
      \draw [->] (comparator) -- node[name=xc(nT)] {$x_{c}(nT)$} (sar_logic);
      \node [block, below of=sar_logic, node distance=3cm] (dac){DAC};
      \node [output, right of=sar_logic, node distance=3cm] (output) {};
    
      % Once the nodes are placed, connecting them is easy. 
      \draw [draw,->] (input) -- node [name=xc(t)] {$x_{c}(t)$}(sample_and_hold);
      \draw [->] (sar_logic) -- node [name=digital_out] {Digital out}(output);
      \draw [->] (sar_logic) -- node [name=nbit] {N-bit} (dac);
      \draw [->] (dac) -| node [name=negfeedback, bend left] {Negative feedback}(comparator);     
  \end{tikzpicture}
  \caption{Block diagram}
  \label{block_diagram}
\end{figure}

\section{Schematic}
We have not completed our resarch in circuits to use in this project. We have created schematics for some simple circuitis but we expect that some (or all) of the circuits is going to change.

\section*{Schematic: SAR\_system}
The SAR\_system is the complete schematic for the whole system. It consists of a sample and hold block, a comarator block, the SAR logic and the digital-to-analog converter block. Figure 
\ref{sar:system} shows the schematic that has been created.\\
\begin{figure}[!ht]
 \centering
   \includegraphics[width=\textwidth]{img/SAR_system}
   \caption{SAR\_system}
   \label{sar:system}
\end{figure}

\section*{Schematic: sample\_hold}
The sample and hold (S/H) is based on a circuit provided by R. Jacob Baker in the book CMOS Mixed-Signal Circut Design \cite{CMOS-baker}. The implementation is a single-ended S/H implementation. 
When $\phi_{1}$ and $\phi_{2}$ is high, $\phi_{3}$ is low, and the bottom plate of the hold capacitor is charged by the input signal, while the top plate is held to ground by the feedback around the 
op amp. When the $\phi_{2}$ is turned off, its charge will be injected into the low impedance input, VIN, since the impedance looking into the left of the $\phi_{2}$ switch is large.\\
\\
This implementation has not yet beed tested, and may therefor be changed during the project.\\
\begin{figure}[!ht]
 \centering
   \includegraphics[width=0.3\textwidth]{img/timing_sample_hold.jpg}
   \caption{Single-ended S/H opartion \cite{CMOS-baker}}
   \label{timing}
\end{figure}
\begin{figure}[!ht]
 \centering
   \includegraphics[width=\textwidth]{img/sample_hold}
   \caption{Sample and hold}
   \label{sample:hold}
\end{figure}


\section*{Schematic: comparator}
The design of the comparator is based on a design in the book Analog Integrated Circuit Design by Carusone, Johns and Martin \cite{Analog-integrated}. 
\begin{figure}[!ht]
 \centering
   \includegraphics[width=\textwidth]{img/comparator}
   \caption{Comparator}
   \label{comparator}
\end{figure}


\section*{Schematic: SAR\_logic}
% \begin{figure}[!ht]
%  \centering
%    \includegraphics[width=0.4\textwidth]{img/SAR_logic}
%    \caption{Single-ended S/H opartion \cite{CMOS-baker}}
%    \label{timing}
% \end{figure}
We have not completed the schematics for the SAR logic.

\section*{Schematic: dac}
\begin{figure}[!ht]
 \centering
   \includegraphics[width=\textwidth]{img/dac}
   \caption{DAC}
   \label{dac}
\end{figure}
This DAC circuit is based on the R-2R ladder from the book Analog Integrated Circuit Design by Carusone, Johns and Martin \cite{Analog-integrated}.

\section*{Schematic: op\_amp}
% \begin{figure}[!ht]
%  \centering
%    \includegraphics[width=0.4\textwidth]{img/timing_sample_hold.jpg}
%    \caption{Single-ended S/H opartion \cite{CMOS-baker}}
%    \label{timing}
% \end{figure}
The op-amp circuit is based on a design from CMOSedu.com (R. Jacob Baker). 

\section{Test bench}
In this section a short overview of the different test-beches for our components is presented.


\section*{Schematic: SIM\_system}
\begin{figure}[!ht]
 \centering
   \includegraphics[width=\textwidth]{img/SIM_system.png}
   \caption{Test bench for SAR-ADC circuit}
   \label{sim:system}
\end{figure}
This is a complete system test bench. Here all the different components come together to form the full SAR-ADC architechture. 
Testing on a system level is nessesary to enshure that the circuit performes according to the interface the circuit provides to the outside world.
This test senario is quite hard to set up since many signals have to be timed to each other. The verification of the circuit is also challanging since many signals has to be considerd.
In order to manage this test we need to generate a test procedure with the spesified stimuli and check the results to a expected pattern.

\section*{Schematic: SIM\_sample\_hold}
\begin{figure}[!ht]
 \centering
   \includegraphics[width=\textwidth]{img/SIM_sample_hold.png}
   \caption{Test bench for sample and hold circuit}
   \label{sim:sh}
\end{figure}
To test the sample and hold we need to generate 3 clocks (see timing diagram in figure \ref{timing}). 
The output is ideely expected to match the input value and hold it in the phi\_3 phase.


\section*{Schematic: SIM\_comparator}
\begin{figure}[!ht]
 \centering
   \includegraphics[width=\textwidth]{img/SIM_comparator.png}
   \caption{Test bench for comparator circuit}
   \label{sim:comparator}
\end{figure}
In the test bench for the comparator we need 3 clocks for the timing. 
When sweeping the input (let's say v-) we expect that at some point (, dependent on v+,) that the comparator will change state. 

\section*{Schematic: SIM\_SAR\_logic}
\begin{figure}[!ht]
 \centering
   \includegraphics[width=\textwidth]{img/SIM_SAR_logic.png}
   \caption{Test bench for SAR-logic circuit}
   \label{sim:logic}
\end{figure}
Some of the circuit in the SAR-logic is given but some extra circuitry is needed. In this test bench we want to test
that the acquisition state is started when the SoC signal is pulsed. And that we recive a EoC after N-bits clock pulses.
We also need to test the reset functionality. 
The main function of generating the digital output is easy to test since the input signal decideds the value of the current bit.


\section*{Schematic: SIM\_dac}
\begin{figure}[!ht]
 \centering
   \includegraphics[width=\textwidth]{img/SIM_dac.png}
   \caption{Test bench for DAC circuit}
   \label{sim:dac}
\end{figure}
The testbench for the DAC consists of N-bits pulse generators so that we can apply a binary pattern. 
VOUT should be proportonal to the binary value.

\section*{Schematic: SIM\_op\_amp}
\begin{figure}[!ht]
 \centering
   \includegraphics[width=\textwidth]{img/SIM_op_amp.png}
   \caption{Test bench for op-amp circuit}
   \label{sim:opamp}
\end{figure}
In our test bench for the opamp we have an open circuit amplifier that expect is going to saturate to either (almost) GND or VDD, if our gain is high enugh.
This simulation is a test to check for response and not performence.
This simple test gives litle information about the performence of the opamp. 
To get a better test of the performence of the circuit we need more tests where we test other configurations of the opamp. 


%\printbibliography{}
\end{document}
